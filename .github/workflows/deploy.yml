name: Treishvaam Enterprise Deploy

# Trigger deployment only on push to main branch
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual trigger from GitHub UI

# Concurrency Group:
# Ensures only ONE build runs at a time. 
# If a new commit comes in while building, it cancels the old one to save RAM.
concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Runs on your Ubuntu VirtualBox
    
    steps:
    # 1. Checkout Code
    - name: Checkout Source Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Shallow clone for speed

    # 2. Setup Java 21 (OPTIMIZED)
    # We REMOVED "cache: maven". 
    # The runner will now use its own local ~/.m2/repository 
    # behaving exactly like a local developer machine (Smart Caching).
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    # 3. Build with Maven (Enterprise Optimized)
    # -DskipTests: Skips unit tests for faster deployment (Run tests in a separate PR workflow if needed)
    # -B: Batch mode (less log noise)
    # -T 1C: Uses 1 CPU Core per thread (Faster builds)
    - name: Build with Maven
      run: ./mvnw clean package -DskipTests -B -T 1C

    # 4. Deploy to Production
    # Since the runner is ON the server, we just copy the file.
    # No need for SSH/SCP.
    - name: Deploy to Application Folder
      run: |
        echo "--> Stopping Background Services to free RAM..."
        # Optional: Stop heavy services during deployment to prevent OOM Kills
        # docker compose -f /opt/treishvaam/docker-compose.yml stop elasticsearch loki tempo

        echo "--> Copying new WAR file..."
        # Copy the built artifact to the target directory
        cp target/finance-api.war /opt/treishvaam/backend-app.war

        echo "--> Restarting Backend..."
        cd /opt/treishvaam
        
        # Recreate only the backend container to apply changes
        docker compose up -d --force-recreate --no-deps backend

        # Restart critical services
        # docker compose start elasticsearch loki tempo
        
        echo "--> Pruning unused Docker images (Space Saving)..."
        docker image prune -f

    # 5. Health Check (Basic Verification)
    - name: Verify Deployment
      run: |
        echo "Waiting for Backend to initialize..."
        sleep 15
        if docker ps | grep -q treishvaam-backend; then
          echo "✅ Backend Container is Running"
        else
          echo "❌ Backend Container failed to start"
          exit 1
        fi