# 08 - Enterprise SEO & Edge Architecture

## 1. Core Strategy: "Materialized HTML" (Hybrid SSG)
To achieve 100% indexability and sub-second load times while maintaining a dynamic React architecture, we use a **Materialized HTML** pattern. This effectively turns our dynamic CMS into a **Static Site Generator (SSG)** on demand.

### The Problem
Traditional SPAs serve an empty `<div>` and rely on client-side JS to render content. This causes:
1.  **Poor SEO**: Bots see "Thin Content" and penalize the ranking.
2.  **Slow FCP**: Users stare at a white screen or spinner while JS downloads.
3.  **Flicker**: Even with "Edge Hydration", React often wipes the DOM before re-rendering.

### The Solution: "Publish-Time Materialization"
Instead of generating HTML *when a user visits* (Server-Side Rendering / SSR), we generate it **once** when the editor clicks "Publish".

### The Flow
1.  **Editor Publishes Post:**
    * Backend saves data to MariaDB.
    * Backend triggers `HtmlMaterializerService` (Async).
    * Service fetches the **Live React Shell** (`index.html`) from the internal Nginx gateway.
    * Service injects:
        * SEO Title & Meta Tags.
        * JSON-LD Schema (Google News compliant).
        * **Full HTML Body Content** (into `<div id="server-content">`).
        * **Redux State** (into `window.__PRELOADED_STATE__`).
    * Service uploads the resulting `.html` file to MinIO (bucket: `treish-public`) under `posts/{slug}.html`.

2.  **Cloudflare Worker (The Router):**
    * Intercepts requests to `/category/...`.
    * Implements a **Cache-First Strategy**:
        * **Strategy A (Static Hit):** Checks MinIO for `posts/{slug}.html`. If found, serves the pre-baked HTML file.
        * **Strategy B (Fallback):** If missing (or Backend down), falls back to fetching API JSON and injecting it into the empty shell (Edge Hydration).

3.  **Client (Browser/Googlebot):**
    * **Googlebot:** Sees fully rendered HTML immediately (`<body>...content...</body>`).
    * **User:** Sees content immediately (FCP < 0.5s).
    * **React:** Detects `window.__PRELOADED_STATE__` and performs **Hydration** instead of Rendering, preventing content flicker.

---

## 2. Technical Implementation

### Backend (Java/Spring Boot)
* **Service:** `HtmlMaterializerService.java`
* **Trigger:** `BlogPostServiceImpl.save()` (on Publish/Update) and `checkAndPublishScheduledPosts()`.
* **Dependencies:** `Jsoup` (for robust DOM manipulation).
* **Live Sync:** Fetches the template from `http://treishvaam-nginx/` to ensure the static page always matches the currently deployed Frontend design version.

### Edge (Cloudflare Worker)
* **Smart Routing:**
    * Parses URL to extract the `slug`.
    * Checks existence of `/api/v1/uploads/posts/{slug}.html`.
    * Adds header `X-Source: Materialized-HTML` on success.
* **Security Headers:** Injects HSTS, CSP, and X-Content-Type-Options into the static HTML response.

### Frontend (React)
* **Entry Logic:** `index.js` inspects `window.__PRELOADED_STATE__`.
* **Hydration Switch:**
    ```javascript
    if (window.__PRELOADED_STATE__) {
      ReactDOM.hydrateRoot(container, <App />); // Attach to existing HTML
    } else {
      ReactDOM.createRoot(container).render(<App />); // Render from scratch
    }
    ```

---

## 3. Robots & Sitemap
* **Robots.txt:** Managed by Cloudflare Worker (dynamic).
* **Sitemaps:** Generated by Backend (`SitemapService`), proxied by Cloudflare Worker to avoid CORS issues and expose them at the root (`/sitemap.xml`).

## 4. Verification & Debugging

We provide an automated script to verify the entire pipeline (Backend -> Storage -> Edge -> Client).

**Script:** `scripts/verify_seo.sh <slug>`

**Checks Performed:**
1.  **MinIO Check:** Verifies the `.html` file exists in the public bucket.
2.  **Worker Check:** Curls the public URL with `User-Agent: Googlebot` and checks for `X-Source: Materialized-HTML`.
3.  **Content Check:** Greps for the injected body content.
4.  **State Check:** Greps for the JSON hydration payload.

**Example Output:**
```bash
$ ./verify_seo.sh market-rally-2025
1. Checking HTML File generation... SUCCESS (200 OK)
2. Checking Cloudflare Worker routing... SUCCESS (Served Pre-rendered HTML)
3. Checking SEO Content Body... SUCCESS (Content Found)
4. Checking React Hydration State... SUCCESS (State Injected)
```