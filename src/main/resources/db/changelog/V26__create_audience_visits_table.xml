<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="V26_1_create_audience_visits_table" author="expert-assistant">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="audience_visits"/>
            </not>
        </preConditions>
        <comment>Creates a table to store historical, detailed Google Analytics audience data.</comment>
        <createTable tableName="audience_visits">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <column name="session_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            
            <column name="session_id" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            
            <column name="client_id" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            
            <column name="country" type="VARCHAR(100)"/>
            <column name="region" type="VARCHAR(100)"/>
            <column name="city" type="VARCHAR(100)"/>
            
            <column name="device_category" type="VARCHAR(50)"/>
            <column name="device_model" type="VARCHAR(100)"/>
            <column name="operating_system" type="VARCHAR(100)"/>
            <column name="os_version" type="VARCHAR(100)"/>
            
            <column name="screen_resolution" type="VARCHAR(50)"/>
            <column name="session_duration_seconds" type="BIGINT"/>
            <column name="session_source" type="VARCHAR(255)"/>
            <column name="landing_page" type="TEXT"/>
            
            <column name="views" type="INT" defaultValue="1"/>
            <column name="created_at" type="DATETIME" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="V26_2_add_indexes" author="expert-assistant">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="audience_visits"/>
            <not>
                <indexExists indexName="idx_audience_visits_date" tableName="audience_visits"/>
            </not>
        </preConditions>
        <comment>Adds indexes for quick historical querying and data retrieval.</comment>
        <createIndex tableName="audience_visits" indexName="idx_audience_visits_date">
            <column name="session_date"/>
        </createIndex>
        <createIndex tableName="audience_visits" indexName="idx_audience_visits_country">
            <column name="country"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>